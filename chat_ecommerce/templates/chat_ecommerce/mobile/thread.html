{% load msg_time %}
{% load static %}
{% load to_user_currency %}
{% load format_decimal %}
{% load i18n %}
{% load compress %}

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" />
  <meta name="description" content="Первый украинский маркетплейс брендовой одежды. Здесь только отборные бренды, нет фейков и безопасная покупка. Заходи и увидишь все сам_а.">
  <title>SALT | Chat </title>
  <link rel="shortcut icon" href="{% static 'img/favicon.ico' %}" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
  {% compress css %}
  <link href="{% static 'fontawesome/css/all.css' %}" rel="stylesheet" type="text/css">
  <link href="{% static 'css/selectize.default.css' %}" rel="stylesheet" type="text/css">
  <link href="{% static 'css/all.css' %}" rel="stylesheet" type="text/css">
  <link href="{% static 'css/themes-base-jquery-ui.css' %}" rel="stylesheet" type="text/css">
  {% endcompress %}
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
  <style type="text/css">

		.btn {
		padding-left: 6px !important;
		}

		.avatar-not-skipped {
			margin: 0 auto;
			width:40px;
		}
		.username-skip{
			text-align: left!important;
		text-overflow: ellipsis;
		white-space: nowrap;
		overflow: hidden;
		}
		#dialog_list{
			display: none
		}

		.back-to-chatlist{
			text-align: left!important;
			display: inline-block!important;

		}
		.dialogs-username{
			text-align: left!important
		}
		.arrow-select-chat{
		display: inline-block!important
		}

		#websocket-form{
		padding-top:0px;
		}

		body {
		padding-bottom: 0;
		margin-bottom:0;
		overflow:hidden;
		}

		html {
		padding-bottom: 0;
		margin-bottom:0;
		}

		#dialogs{
		width: 320px;
		padding-right: 0px;
		/*	overflow: scroll;*/
		margin-bottom: 0;
		position: relative;

		height:auto;
		overflow:auto;
		max-height: calc(100vh - 130px); 

		}

		#dialog{
		height:70px;
		/*	display: flex;
		align-items: center;*/

		}

		#dialog:hover{
		background-color: #f2f2f2;
		}


		.fa-paper-plane{
		color: #9da3a5;
		}


		#chat-message{
		word-wrap: break-word;
		overflow-wrap: break-word;
		/*	text-align: left;*/
		}

		button:focus {
			outline:0 !important;
		}


		*:focus {
		outline:none !important;
		}

		.btn:focus {
		outline:none !important;
		}

		.avatar-chat{
		width:50px; 
		height: 50px;
		}

		.avatar-small{
		width:40px; 
		height: 40px;

		}

		#dialog:hover{
		background-color: #f2f2f2;
		}



		.fa-paper-plane{
		color: #9da3a5;
		}


		#chat-message{
		word-wrap: break-word;
		overflow-wrap: break-word;
		/*	text-align: left;*/
		}

		button:focus {
			outline:0 !important;
		}


		*:focus {
		outline:none !important;
		}

		.btn:focus {
		outline:none !important;
		}

		.avatar-chat{
		width:50px; 
		height: 50px;
		}

		.avatar-small{
		width:40px; 
		height: 40px;
		}


		.active {
		background-color: #e9ebeb;
		}

		.row-dialog {
		height: 70px;

		}

		.backgroundy{
		background-color: black;
		}

		.blacky{
		background-color: #f2f2f2;
		}

		.rounder-form{
		border-bottom-left-radius: 25px !important;
		border-top-left-radius: 25px !important;
		border-top-right-radius: 25px !important;
		border-bottom-right-radius: 25px !important;
		}

		.rounder-msg-cloud-right{
		border-bottom-left-radius: 25px !important;
		border-top-left-radius: 25px !important;
		border-top-right-radius: 25px !important;
		border-bottom-right-radius: 0px !important;
		}

		.rounder-msg-cloud-left{
		border-bottom-left-radius: 0px !important;
		border-top-left-radius: 25px !important;
		border-top-right-radius: 25px !important;
		border-bottom-right-radius: 25px !important;
		}

		.msg-cloud{
		background-color: #f2f2f2;
		display:inline-block; 
		max-width:inherit; 
		max-width: 75%;
		line-height: 1;
		}

		.timestamp {
		font-size: xx-small;
		}

		.dialogs-username {
		overflow: hidden; 
		white-space: nowrap; 
		text-overflow: ellipsis;
		}



		.active {
		background-color: #e9ebeb;
		}

		.row-dialog {
		height: 70px;
		}

		.back-to-chatlist{
		display: none
		}
		.row-avatar-arrow{
		text-align: right!important;
		}
		.arrow-select-chat{
		display: none
		}

		.backgroundy{
		background-color: black;
		}

		.blacky{
		background-color: #f2f2f2;
		}

		.rounder-form{
		border-bottom-left-radius: 25px !important;
		border-top-left-radius: 25px !important;
		border-top-right-radius: 25px !important;
		border-bottom-right-radius: 25px !important;
		}

		.rounder-msg-cloud-right{
		border-bottom-left-radius: 25px !important;
		border-top-left-radius: 25px !important;
		border-top-right-radius: 25px !important;
		border-bottom-right-radius: 0px !important;
		}

		.rounder-msg-cloud-left{
		border-bottom-left-radius: 0px !important;
		border-top-left-radius: 25px !important;
		border-top-right-radius: 25px !important;
		border-bottom-right-radius: 25px !important;
		}

		.msg-cloud{
		background-color: #f2f2f2;
		/*	display:inline-block; 
		max-width:inherit; 
		max-width: 75%;*/
		display: inline-block;
		max-width: 75%;
		overflow-wrap: break-word;
		}

		.dot {
		height: 8px;
		width: 8px;
		background-color: #cf6369;
		border-radius: 50% !important;
		display: inline-block;
		}

		.dot_blue {
		height: 8px;
		width: 8px;
		background-color: blue;
		border-radius: 50% !important;
		display: inline-block;
		}

		.today{
		font-size: 10px; text-transform: uppercase; padding-right: 5px
		}

		.hr-today{
		margin-bottom: 0.2rem; width: 82%;display: inline-block;
		}


		#chat-items{
		padding-left: 15px;
		padding-right: 15px;
		position: relative;
		margin-bottom: 0px;
		overflow:auto;
		height: 60vh;
		}

		/*	Large phones :*/
		@media screen and (min-height: 668px) {
		#chat-items{
		max-height: calc(100vh - 20vh); 
		min-height: calc(100vh - 20vh); 
		padding-bottom: 30px;
		}
		}

		/*	iPhone 5:*/
		@media screen and (max-width: 370px) {
		#chat-items{
		max-height: calc(100vh - 29vh); 
		min-height: calc(100vh - 29vh); 
		}
		}
 </style>
</head>
<body>
	{% include 'mobile/navbar.html' %}

	{% with me=request.user my_url=request.user.get_absolute_url my_photo=request.user.get_profile_photo opposite_user_username=opposite_user.username opposite_user_url=opposite_user.get_absolute_url opposite_user_photo=opposite_user.get_profile_photo %}

	<div class='container-fluid'> 
	<div class='row'>
	
		<div id='dialog_list' class='col-12' style='border-right: 0.75px solid #e1e6e6;'>
			<div class='row' style='height: 54px; background-color: #efefef;'>
				<div class='col text-center my-auto'>
					<a href="{{ my_url  }}" style='text-decoration: none; color: inherit'>
						<img src="{{ my_photo }}" class="avatar-small avatar  ml-2" alt="...">
					</a>
				</div>
			</div>
			<div class='row alldialogs'>
				<ul id='dialogs' class='my-custom-scrollbar' style="width: 100%">
					{% for obj in chats %}
						{% if me != obj.first %}			
							{% with url=obj.get_absolute_url_first photo=obj.first.get_profile_photo	username=obj.first.username %}
								{% include 'chat_ecommerce/mobile/alldialogs.html' %}
							{% endwith %}
						{% else %}			
							{% with url=obj.get_absolute_url_second photo=obj.second.get_profile_photo username=obj.second.username %}
								{% include 'chat_ecommerce/mobile/alldialogs.html' %}
							{% endwith %}		
						{% endif %}
					{% endfor %}
				</ul>
			</div>
		</div>

		<div id='navbar-chat' class='col-12 p-0'>
			<div class='navbar sticky-top p-0' id='' style='width: 100%; background-color: #efefef; margin-top:5%'>
				<div class='col-6 col-md-5 text-right p-2 my-auto avatar-not-skipped'>
				<div class="row row-avatar-arrow">
				<div class="col-6 my-auto back-to-chatlist">
				<button class="btn btn-back-to-list"><i class="fas fa-lg fa-chevron-left"></i></button>
				</div>
				<div class="col-6 col-md-12 foto-mobile">
					<a href="{{ opposite_user_url  }}" style='text-decoration: none; color: inherit'>
						<img src="{{ opposite_user_photo }}" class="avatar-small avatar  ml-2" alt="...">
					</a>
				</div>
				</div>
				</div>

				<div class='col-6 col-md-7 text-left p-1 my-auto username-skip'>
					<a href="{{ opposite_user_url  }}" style='text-decoration: none; color: inherit'>	
					{{ opposite_user_username }}
					</a>
					{% if object.product and me != object.product.user %}
						<div style='float: right!important;'>
							<form method="POST" action="{% url 'orders:transaction_initiate' %}">{% csrf_token %}
								<input type="hidden" name="next" value="{{ request.path }}" readonly="true">
								<input type="hidden" name="product" value="{{ object.product.id }}" readonly="true">
								<input type="hidden" name="opponent" value="{{ object }}" readonly="true">
								<button type="submit" class="btn btn-dark border-dark">Buy</button>
							</form>
						</div>
					{% elif object.product and me == object.product.user %}
					<!-- Transaction initiated, but not confirmed -->
						{% if object.transaction_thread.accepted == False %}
							<div style='float: right!important;'>
								<button class="btn btn-light border-dark">Sell</button>
							</div>
						{% endif %}
					<!-- Transaction initiated, but not confirmed -->
					{% endif %}
				</div>
			</div>
		</div>

		<div id='chat_list_mobile' class='col-12' style='margin-top: 0px'>
			<div class='row '>
				<div class='col p-0'>
					<ul id='chat-items'  >
						{% for msg in chat_messages_ordered %}
							<li>
								<div class='row'>
									<div class="col {% if msg.user == me %}pull-right{% else %}pull-left{% endif %}" id='chat-message'>
										<input type="hidden" name="first_message_today" value="{{ msg.is_today }}" readonly="true">
										<div hidden>
											<span class='today'>{% trans 'Today' %}</span>
											<hr class='hr-today'>
										</div>
										<div class='col-flex  mb-1 mt-1 p-2 pull-left msg-cloud {% if msg.user == me %}rounder-msg-cloud-right{% else %}rounder-msg-cloud-left{% endif %}'>
											{{ msg.message }}<br>
											<span class="timestamp"> {{ msg.timestamp|print_timestamp }}</span>
										</div>
									</div>
								</div>
							</li>
						{% endfor %}
					</ul>
				</div>
			</div>

			<form id='websocket-form' method='POST' style='position: fixed; bottom:0'>
			<div class='row' style='background-color: #efefef;'>
				{% csrf_token %}
				<div class='col-10 my-auto pr-0'>
					{{ form }}
				</div>
				<div class='col-2 my-auto'>
					<button type='submit' class='btn' style='padding-left: 0rem !important'>
						<i class="fas fa-paper-plane fa-2x"></i>
					</button>
				</div>
			</div>
			</form>	
		</div>

	</div>
	</div>

	{% endwith %}

	<script>

		// Input autofocus
		var messageForm = $("#id_message")
		var currentPath = window.location.href
		if (currentPath.indexOf("messages") != -1){
			messageForm.focus();
		}


		// Today separator 
		inputs = $('input[name=first_message_today]')
		jQuery.each(inputs, function(index, item) {
			if (item.value=='True') {
				var firstTodayInput = $(item)
				var next = firstTodayInput.next()
				next.attr("hidden",false);
				return false;
			}
		});

		//go to the bottom 
		var chat = document.getElementById('chat-items')
		chat.scrollTop = chat.scrollHeight; 


		// buttons back 
		var btnBackListChat = $('.btn-back-to-list')
		btnBackListChat.click(
			function(e){
				$('#dialog_list').attr('style', 'display:block!important')
				$('#chat_list_mobile').attr('style', 'display:none!important')
				$('#navbar-chat').attr('style', 'display:none!important')
			})//click btn
	</script>
 	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-150733918-1"></script>
	{% compress js file base %}	
    <script type="application/javascript" src="{% static 'js/jquery.lazyloadxt.min.js' %}"></script>
    <script type="application/javascript" src="{% static 'js/jquery.lazyloadxt.bootstrap.min.js' %}"></script>
    <script type="application/javascript" src="{% static 'js/jquery.lazyloadxt.jquerymobile.min.js' %}"></script>
    <script type="application/javascript" src="{% static 'js/jsrender.min.js' %}"></script>
    <script type="application/javascript" src="{% static 'js/jquery-ui.min.js' %}"></script>
    <script type="application/javascript" src='{% static "js/ecommerce-mobile.js" %}'></script>
    <script type="application/javascript" src='{% static "js/csrf.ajax.js" %}'></script>
    <script type="application/javascript" defer src="{% static 'fontawesome/js/all.js' %}"></script>
    <script type="application/javascript" src="{% static 'js/jquery.slidereveal.min.js' %}"></script>
    {% endcompress %}
</body>
</html>