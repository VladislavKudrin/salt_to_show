{% load msg_time %}
{% load static %}
{% load checked_time %}
{% load to_user_currency %}
{% load format_decimal %}
{% load i18n %}
{% load compress %}

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" />
  <meta name="description" content="Первый украинский маркетплейс брендовой одежды. Здесь только отборные бренды, нет фейков и безопасная покупка. Заходи и увидишь все сам_а.">
  <title>SALT | Chat </title>
  <link rel="shortcut icon" href="{% static 'img/favicon.ico' %}" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
  {% compress css %}
  <link href="{% static 'fontawesome/css/all.css' %}" rel="stylesheet" type="text/css">
  <link href="{% static 'css/selectize.default.css' %}" rel="stylesheet" type="text/css">
  <link href="{% static 'css/all.css' %}" rel="stylesheet" type="text/css">
  <link href="{% static 'css/themes-base-jquery-ui.css' %}" rel="stylesheet" type="text/css">
  {% endcompress %}
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
  <style type="text/css">

		.btn {
			padding-left: 6px !important;
		}

	  .avatar-not-skipped {
	  	margin: 0 auto;
	  	width:40px;
	  }
	  .username-skip{
	  	text-align: left!important;
		text-overflow: ellipsis;
		white-space: nowrap;
		overflow: hidden;
	  }
	  #dialog_list{
	  	display: none
	  }
	  #input-row{
	  	width: 100%!important;
	  }
	  .back-to-chatlist{
	  	text-align: left!important;
	  	display: inline-block!important;

	  }
	  .dialogs-username{
	  	text-align: left!important
	  }
	  .arrow-select-chat{
		display: inline-block!important
	}

	#websocket-form{
		padding-top:0px;
	}

	body {
	    padding-bottom: 0;
	    margin-bottom:0;
	}

	html {
		padding-bottom: 0;
	    margin-bottom:0;
	}

	#dialogs{
		width: 320px;
		padding-right: 0px;
	/*	overflow: scroll;*/
		margin-bottom: 0;
		position: relative;

	    height:auto;
	    overflow:auto;
		max-height: calc(100vh - 130px); 

	}

	#dialog{
		height:70px;
	/*	display: flex;
	    align-items: center;*/

	}

	#dialog:hover{
		background-color: #f2f2f2;
	}

	#input-row{
		background-color: #efefef;
		height: 60px;
	}

	.fa-paper-plane{
		color: #9da3a5;
	}


	#chat-message{
		word-wrap: break-word;
		overflow-wrap: break-word;
	/*	text-align: left;*/
	}

	button:focus {
	 	outline:0 !important;
	}


	*:focus {
		outline:none !important;
	}

	.btn:focus {
		outline:none !important;
	}

	.avatar-chat{
		width:50px; 
		height: 50px;
	}

	.avatar-small{
		width:40px; 
		height: 40px;

	}

	#dialog:hover{
		background-color: #f2f2f2;
	}

	#input-row{
		background-color: #efefef;
		height: 60px;
	}

	.fa-paper-plane{
		color: #9da3a5;
	}


	#chat-message{
		word-wrap: break-word;
		overflow-wrap: break-word;
	/*	text-align: left;*/
	}

	button:focus {
	 	outline:0 !important;
	}


	*:focus {
		outline:none !important;
	}

	.btn:focus {
		outline:none !important;
	}

	.avatar-chat{
		width:50px; 
		height: 50px;
	}

	.avatar-small{
		width:40px; 
		height: 40px;
	}


	.active {
		background-color: #e9ebeb;
	}

	.row-dialog {
		height: 70px;

	}

	.backgroundy{
		background-color: black;
	}

	.blacky{
		background-color: #f2f2f2;
	}

	.rounder-form{
		border-bottom-left-radius: 25px !important;
		border-top-left-radius: 25px !important;
		border-top-right-radius: 25px !important;
		border-bottom-right-radius: 25px !important;
	}

	.rounder-msg-cloud-right{
		border-bottom-left-radius: 25px !important;
		border-top-left-radius: 25px !important;
		border-top-right-radius: 25px !important;
		border-bottom-right-radius: 0px !important;
	}

	.rounder-msg-cloud-left{
		border-bottom-left-radius: 0px !important;
		border-top-left-radius: 25px !important;
		border-top-right-radius: 25px !important;
		border-bottom-right-radius: 25px !important;
	}

	.msg-cloud{
		background-color: #f2f2f2;
		display:inline-block; 
		max-width:inherit; 
		max-width: 75%;
		line-height: 1;
	}

	.timestamp {
		font-size: xx-small;
	}

	.dialogs-username {
		overflow: hidden; 
		white-space: nowrap; 
		text-overflow: ellipsis;
	}



	.active {
		background-color: #e9ebeb;
	}

	.row-dialog {
		height: 70px;
	}

	.back-to-chatlist{
		display: none
	}
	.row-avatar-arrow{
		text-align: right!important;
	}
	.arrow-select-chat{
		display: none
	}

	.backgroundy{
		background-color: black;
	}

	.blacky{
		background-color: #f2f2f2;
	}

	.rounder-form{
		border-bottom-left-radius: 25px !important;
		border-top-left-radius: 25px !important;
		border-top-right-radius: 25px !important;
		border-bottom-right-radius: 25px !important;
	}

	.rounder-msg-cloud-right{
		border-bottom-left-radius: 25px !important;
		border-top-left-radius: 25px !important;
		border-top-right-radius: 25px !important;
		border-bottom-right-radius: 0px !important;
	}

	.rounder-msg-cloud-left{
		border-bottom-left-radius: 0px !important;
		border-top-left-radius: 25px !important;
		border-top-right-radius: 25px !important;
		border-bottom-right-radius: 25px !important;
	}

	.msg-cloud{
		background-color: #f2f2f2;
	/*	display:inline-block; 
		max-width:inherit; 
		max-width: 75%;*/
		display: inline-block;
		max-width: 75%;
		overflow-wrap: break-word;
	}

	.dot {
	  height: 8px;
	  width: 8px;
	  background-color: #cf6369;
	  border-radius: 50% !important;
	  display: inline-block;
	}

	.dot_blue {
	  height: 8px;
	  width: 8px;
	  background-color: blue;
	  border-radius: 50% !important;
	  display: inline-block;
	}

	.today{
		font-size: 10px; text-transform: uppercase; padding-right: 5px
		}

	.hr-today{
		margin-bottom: 0.2rem; width: 82%;display: inline-block;
	}


	#chat-items{
		padding-left: 15px;
	  	padding-right: 15px;
	  	padding-bottom: 23px;
		position: relative;
		margin-bottom: 0px;
	    height:auto;
	    overflow:auto;
		max-height: calc(100vh - 25vh); 
		min-height: calc(100vh - 25vh); 
	}

	/*	Large phones :*/
	@media screen and (min-height: 668px) {
		#chat-items{
		max-height: calc(100vh - 20vh); 
		min-height: calc(100vh - 20vh); 
		padding-bottom: 30px;
	}
	}

	/*	iPhone 5:*/
	@media screen and (max-width: 370px) {
		#chat-items{
		max-height: calc(100vh - 29vh); 
		min-height: calc(100vh - 29vh); 
	}
	}

 </style>
</head>
<body>
	{% include 'mobile/navbar.html' %}
	<div class='container-fluid'> 
	<div class='row'>
		<div class='col-12' id='dialog_list' style='border-right: 0.75px solid #e1e6e6;'>
			<div class='row' style='height: 54px; background-color: #efefef;'>
				<div class='col text-center my-auto'>
					<a href="{{ request.user.get_absolute_url  }}" style='text-decoration: none; color: inherit'>
					{% if request.user.profile_foto %}
						<img src="{{ request.user.profile_foto.url }}"  class="avatar-small avatar  ml-2" alt="...">
					{% else %}
						<img src="{% static 'img/user_noname.png' %}" class=" avatar-small avatar">
					{% endif %}
					</a>
				</div>
			</div>
			<div class='row alldialogs'>
				<ul id='dialogs'  style="width: 100%">
					{% for obj in chats %}
						{% if request.user != obj.first %}
							<li id='dialog' class="mr-0"><a href="{{ obj.get_absolute_url_first }}" style='text-decoration: none; color: inherit'>
								<div class='row row-dialog my-auto mx-auto'>
									<div class='col-4 col-md-3 my-auto'>
										{% if obj.product %}
											{% with obj.product.thumbnail.all|first as thumbnail %}
												<img src="{{ thumbnail.thumbnail.url }}" class=" avatar-chat avatar avatar-skip">
											{% endwith %}
										{% else %}
											{% if obj.first.profile_foto %}
												<img src="{{ obj.first.profile_foto.url }}"  class="avatar-chat avatar  avatar-skip" alt="...">
											{% else %}
												<img src="{% static 'img/user_noname.png' %}" class=" avatar-chat avatar avatar-skip"  >
											{% endif %}
										{% endif %}
									</div>
									{% if obj.product and request.user != obj.product.user %}
										<div class='col-4 col-md-9 pl-md-0 text-left dialogs-username'>
										<div class="row my-auto">
											<div class="col-6 text-center">
												<b>{{ obj.first.username }}</b>
											</div>
											<div class="col-6 text-right">
												<small>{{ obj.product|to_user_currency:request }}</small>
											</div>
										</div>
										<div class="row mt-2">
											<div class="col-12 text-left my-auto">
												<small>{{ obj.product.title }}</small>
											</div>
										</div>
										<span class='obj_id_s' id="{{ obj.id }}"></span>
										</div>
									{% else %}
										<div class='col-4 col-md-8 text-left my-auto dialogs-username'>
											{{ obj.first.username }}
											{% if threads_with_unred %}
												{% for noti in threads_with_unred %}
													{% if noti == obj %}
														<span class="dot" id="{{ obj.id }}"></span>
													{% endif %}
												{% endfor %}
											{% endif %}
										<span class='obj_id_s' id="{{ obj.id }}"></span>
										</div>
									{% endif %}
									<div class="col-4 my-auto text-right arrow-select-chat">
										<i class="fas fa-lg fa-chevron-right"></i>
									</div>
								</div>
							</a></li>
						{% else %}
							<li id='dialog' class="mr-0"><a href="{{ obj.get_absolute_url_second }}" style='text-decoration: none;color: inherit;'>
								<div class='row row-dialog my-auto mx-auto'>
									<div class='col-4 col-md-3 my-auto'>
										{% if obj.product %}
											{% with obj.product.thumbnail.all|first as thumbnail %}
												<img src="{{ thumbnail.thumbnail.url }}" class=" avatar-chat avatar avatar-skip">
											{% endwith %}
										{% else %}
											{% if obj.second.profile_foto %}
												<img src="{{ obj.second.profile_foto.url }}"  class="avatar-chat avatar  avatar-skip" alt="..." >
											{% else %}
												<img src="{% static 'img/user_noname.png' %}" class=" avatar-chat avatar avatar-skip" >
											{% endif %}
										{% endif %}
									</div>
									{% if obj.product and request.user != obj.product.user %}
										<div class='col-4 col-md-9 pl-md-0 text-left dialogs-username'>
											<div class="row my-auto">
												<div class="col-6 text-center">
													<b>{{ obj.second.username }}</b>
												</div>
												<div class="col-6 text-right">
													<small>{{ obj.product|to_user_currency:request }}</small>
												</div>
											</div>
											<div class="row mt-2">
												<div class="col-12 text-left my-auto">
													<small>{{ obj.product.title }}</small>
												</div>
											</div>
											<span class='obj_id_s' id="{{ obj.id }}"></span>
										</div>
									{% else %}
									<div class='col-4 col-md-8 text-left my-auto dialogs-username'>
										{{ obj.second.username }}
										{% if threads_with_unred %}
											{% for noti in threads_with_unred %}
												{% if noti == obj %}
													<span class="dot" id="{{ obj.id }}"></span>
												{% endif %}
											{% endfor %}
										{% endif %}
									<span class='obj_id_s' id="{{ obj.id }}"></span>
									</div>
									{% endif %}
									<div class="col-4 my-auto text-right arrow-select-chat">
										<i class="fas fa-lg fa-chevron-right"></i>
									</div>
								</div>
							</a></li>
						{% endif %}
					{% endfor %}
				</ul>
			</div>
		</div>
		<div class='col-12' id='chat_list_mobile'>
			<div class='row opponent' id='{% if request.user != object.first %}{{ object.first.username }}{% else %}{{ object.second.username }}{% endif %}' style='height: 54px; background-color: #efefef;'>
				<div class='col text-center my-auto'>
						{% if request.user != object.first %}
								<!-- THATS FOR THE FIRST USER IN THREAD -->
								<div class='row justify-content-center'>

									<div class='col-6 col-md-5 text-right p-2 my-auto avatar-not-skipped'>
									<div class="row row-avatar-arrow">
									<div class="col-6 my-auto back-to-chatlist">
									<button class="btn btn-back-to-list"><i class="fas fa-lg fa-chevron-left"></i></button>
									</div>
									<div class="col-6 col-md-12 foto-mobile">
									{% if object.first.profile_foto %}
										<a href="{{ object.first.get_absolute_url  }}" style='text-decoration: none; color: inherit'>	
											<img src="{{ object.first.profile_foto.url }}"  class="avatar-small avatar  ml-2 " alt="...">
										</a>
									{% else %}
										<a href="{{ object.first.get_absolute_url  }}" style='text-decoration: none; color: inherit'>	
											<img src="{% static 'img/user_noname.png' %}" class=" avatar-small avatar "  >
										</a>
									{% endif %}
									</div>
									</div>
									</div>

									<div class='col-6 col-md-7 text-left p-1 my-auto username-skip'>
									<a href="{{ object.first.get_absolute_url  }}" style='text-decoration: none; color: inherit'>	
									{{ object.first.username }}
									</a>
									{% if object.product and request.user != object.product.user %}
										<div style='float: right!important;'>
											<form method="POST" action="{% url 'orders:transaction_initiate' %}">{% csrf_token %}
												<input type="hidden" name="next" value="{{ request.path }}" readonly="true">
												<input type="hidden" name="product" value="{{ object.product.id }}" readonly="true">
												<input type="hidden" name="opponent" value="{{ object.first }}" readonly="true">
												<button type="submit" class="btn btn-dark border-dark">Buy</button>
											</form>
											
										</div>
									{% elif object.product and request.user == object.product.user %}
									<!-- Transaction initiated, but not confirmed -->
										{% if object.transaction_thread.accepted == False %}
											<div style='float: right!important;'>
												<button class="btn btn-light border-dark">Sell</button>
											</div>
										{% endif %}
									<!-- Transaction initiated, but not confirmed -->
									{% endif %}
									</div>
								</div>
						
						{% else %}
						<!-- THATS FOR THE SECOND USER -->
								<div class='row justify-content-center'>
									<div class='col-6 col-md-5 text-right p-2 my-auto avatar-not-skipped'>
									<div class="row row-avatar-arrow">
									<div class="col-6 my-auto back-to-chatlist">
									<button class="btn btn-back-to-list"><i class="fas fa-lg fa-chevron-left"></i></button>
									</div>
									<div class="col-6 col-md-12 foto-mobile">
									{% if object.second.profile_foto %}
									<a href="{{ object.second.get_absolute_url  }}" style='text-decoration: none; color: inherit'>
										<img src="{{ object.second.profile_foto.url }}"  class="avatar-small avatar ml-2 " alt="..." >
									</a>
									{% else %}

									<a href="{{ object.second.get_absolute_url  }}" style='text-decoration: none; color: inherit'>
										<img src="{% static 'img/user_noname.png' %}" class=" avatar-small avatar "  >
									</a>
									{% endif %}
									</div>
									</div>
									</div>

									<div class='col-6 col-md-7 text-left p-1 my-auto username-skip'>
									<a href="{{ object.second.get_absolute_url }}" style='text-decoration: none; color: inherit'>
									{{ object.second.username }}
								    </a>
									{% if object.product and request.user != object.product.user %}
										<div style='float: right!important;'>
											<form method="POST" action="{% url 'orders:transaction_initiate' %}">{% csrf_token %}
												<input type="hidden" name="next" value="{{ request.path }}" readonly="true">
												<input type="hidden" name="product" value="{{ object.product.id }}" readonly="true">
												<input type="hidden" name="opponent" value="{{ object.second }}" readonly="true">
												<button type="submit" class="btn btn-dark border-dark">Buy</button>
											</form>
									
										</div>
									{% elif object.product and request.user == object.product.user %}
									<!-- Transaction initiated, but not confirmed -->
										{% if object.transaction_thread.accepted == False %}
											<div style='float: right!important;'>
												<button class="btn btn-light border-dark">Sell</button>
											</div>
										{% endif %}
									<!-- Transaction initiated, but not confirmed -->
									{% endif %}
									</div>
								</div>	
						
						{% endif %}
					</div>
				</div>
			





			<div class='row '>
				<div class='col p-0'>
					<ul id='chat-items'  >
							{% for msg in chat_messages_ordered %}
								<li>
									<div class='row'>
									<div class="col {% if msg.user == request.user %}pull-right{% else %}pull-left{% endif %}" id='chat-message'>

											<input type="hidden" name="first_message_today" value="{{ msg.is_today }}" readonly="true">
											<div hidden>
												<span class='today'>{% trans 'Today' %}</span>
												<hr class='hr-today'>
											</div>


										{% if msg.user == request.user %}

											<div class='col-flex rounder-msg-cloud-right mb-1 mt-1 p-2 pull-left msg-cloud'>
											{{ msg.message }}<br>

											<span class="timestamp"> {{ msg.timestamp|print_timestamp }}</span>

											</div>

										{% else %}


											<div class='col-flex rounder-msg-cloud-left mb-1 mt-1 p-2 pull-left msg-cloud'>
											{{ msg.message }}<br>

											<span class="timestamp"> {{ msg.timestamp|print_timestamp }}</span>
											</div>

										{% endif %}
								
					
									</div>
								</div>

								</li>
							{% endfor %}
					</ul>
				</div>
			</div>

			<div class='row'>
				<form id='websocket-form' method='POST'>
				 {% csrf_token %}
					<div class='row' id='input-row' style='position: fixed;bottom: 0; width:77%; margin-left:0px;' >
						<div class='col-10 col-md-11 my-auto pr-0'>
							{{ form }}
							</div>
						<div class='col-2 col-md-1 my-auto pl-0' >
							<button type='submit' class='btn'>
							<i class="fas fa-paper-plane fa-2x"></i>
							</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
	</div>
	<script>

		// Input autofocus
		var messageForm = $("#id_message")
		var currentPath = window.location.href
		if (currentPath.indexOf("messages") != -1){
			messageForm.focus();
		}


		// Today separator 
		inputs = $('input[name=first_message_today]')
		jQuery.each(inputs, function(index, item) {
			if (item.value=='True') {
				var firstTodayInput = $(item)
				var next = firstTodayInput.next()
				next.attr("hidden",false);
				return false;
			}
		});

		//go to the bottom 
		var chat = document.getElementById('chat-items')
		chat.scrollTop = chat.scrollHeight; 


		// buttons back 
		var btnBackListChat = $('.btn-back-to-list')
		btnBackListChat.click(
			function(e){
				$('#dialog_list').attr('style', 'display:block!important')
				$('#chat_list_mobile').attr('style', 'display:none!important')
			})//click btn
	</script>
 	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-150733918-1"></script>
	{% compress js file base %}	
    <script type="application/javascript" src="{% static 'js/jquery.lazyloadxt.min.js' %}"></script>
    <script type="application/javascript" src="{% static 'js/jquery.lazyloadxt.bootstrap.min.js' %}"></script>
    <script type="application/javascript" src="{% static 'js/jquery.lazyloadxt.jquerymobile.min.js' %}"></script>
    <script type="application/javascript" src="{% static 'js/jsrender.min.js' %}"></script>
    <script type="application/javascript" src="{% static 'js/jquery-ui.min.js' %}"></script>
    <script type="application/javascript" src='{% static "js/ecommerce-mobile.js" %}'></script>
    <script type="application/javascript" src='{% static "js/csrf.ajax.js" %}'></script>
    <script type="application/javascript" defer src="{% static 'fontawesome/js/all.js' %}"></script>
    <script type="application/javascript" src="{% static 'js/jquery.slidereveal.min.js' %}"></script>
    {% endcompress %}
</body>
</html>